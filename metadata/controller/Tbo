{
    "type": "Ext.app.Controller",
    "reference": {
        "name": "items",
        "type": "array"
    },
    "codeClass": null,
    "userConfig": {
        "designer|userClassName": "Tbo"
    },
    "name": "MyController",
    "designerId": "71fe2662-4115-4635-97e6-8a7ca4fa0050",
    "cn": [
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "#btAddPererTbo",
                "designer|params": [
                    "button",
                    "e",
                    "eOpts"
                ],
                "designer|targetType": "Ext.button.Button",
                "fn": "onBtAddPererTboClick",
                "implHandler": [
                    "// in use",
                    "var value = button.findParentByType('form').getValues();",
                    "//STORE",
                    "var stUser = Ext.data.StoreManager.get(\"StUser\");",
                    "//LOGIN & PASSWORD",
                    "",
                    "",
                    "",
                    "//LOGIKA",
                    "var grid = Ext.getCmp('grTarifHousesTbo');",
                    "//var store = grid.getStore();",
                    "var gridRowSelectedRecords  = grid.getView().getSelectionModel().getSelection();",
                    "var size = Ext.Object.getSize(gridRowSelectedRecords) ;",
                    "var values =stUser.getAt(0);",
                    "var params =[];",
                    "if (size > 1){",
                    "    params = {",
                    "        login:values.get('login'),",
                    "        password:values.get('password'),",
                    "        what:\"pereraschet_tbo\",",
                    "        allkv:value.allkv,",
                    "        tarif_manual:0,",
                    "        sdata:value.sdata,",
                    "        fdata:value.fdata,",
                    "        address_ot:value.address_ot,",
                    "        address_do:value.address_do,",
                    "        info:value.info",
                    "    };",
                    "} else {",
                    "",
                    "    params = {",
                    "        login:values.get('login'),",
                    "        password:values.get('password'),",
                    "        what:\"pereraschet_tbo\",",
                    "        allkv:value.allkv,",
                    "        tarif_manual:value.tarif_manual,",
                    "        tbo:value.tbo,",
                    "        ch_tbo:value.ch_tbo,",
                    "        sdata:value.sdata,",
                    "        fdata:value.fdata,",
                    "        address_ot:value.address_ot,",
                    "        address_do:value.address_do,",
                    "        info:value.info",
                    "    };",
                    "}",
                    "var house = \"\";",
                    "var myMask = Ext.Msg.show({",
                    "    title:'Перерасчет по ТБО',",
                    "    msg: 'Выполнение перерасчета.Ожидайте...',",
                    "    buttons: Ext.Msg.CANCEL,",
                    "    wait: true,",
                    "    modal: true,",
                    "    icon: Ext.Msg.INFO",
                    "});",
                    "Ext.Object.each(gridRowSelectedRecords, function(key, val, myself) {",
                    "    Ext.Object.merge(val.data, params);",
                    "",
                    "    QueryAddress.updateRecords(val.data,function(results){",
                    "       // console.log(results);",
                    "",
                    "        if(results.success===\"1\"){",
                    "            myMask.close();",
                    "",
                    "            Ext.MessageBox.show({",
                    "                title: 'Перерасчет ТБО',",
                    "                msg: \"Перерасчет ТБО выполнен\",",
                    "                buttons: Ext.MessageBox.OK,",
                    "                icon: Ext.MessageBox.INFO",
                    "            });",
                    "        }  else {",
                    "            house =val.data.house;",
                    "            myMask.close();",
                    "            Ext.MessageBox.show({",
                    "                title: 'Перерасчет ТБО ',",
                    "                msg: \"Перерасчет не выполнен по дому \"+ house ,",
                    "                buttons: Ext.MessageBox.OK,",
                    "                icon: Ext.MessageBox.ERROR",
                    "            });",
                    "",
                    "        }",
                    "    });",
                    "});",
                    ""
                ],
                "name": "click"
            },
            "name": "onBtAddPererTboClick",
            "designerId": "8a7dd156-46b4-4f57-8f45-5d7417a7340f"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "#btAddNachTbo",
                "designer|params": [
                    "button",
                    "e",
                    "eOpts"
                ],
                "designer|targetType": "Ext.button.Button",
                "fn": "onBtAddNachTboClick",
                "implHandler": [
                    "// in use",
                    "var me = this;",
                    "//STORE",
                    "var stUser = Ext.data.StoreManager.get(\"StUser\");",
                    "var grid =  Ext.getCmp('grTarifHousesTbo');",
                    "",
                    "var getRowSelection = grid.getSelectionModel().getSelection()[0];",
                    "var house_id = getRowSelection.get('house_id');",
                    "//LOGIN & PASSWORD",
                    "var values =stUser.getAt(0);",
                    "var params = {",
                    "    login:values.get('login'),",
                    "    password:values.get('password'),",
                    "    what:\"nachislenie_tbo_now\",",
                    "    house_id:house_id",
                    "};",
                    "",
                    "",
                    "//LOGIKA",
                    "",
                    "var myMask= Ext.Msg.show({",
                    "    title:'Начисление...',",
                    "    msg: 'Начисление услуги.Ожидайте...',",
                    "    buttons: Ext.Msg.CANCEL,",
                    "    wait: true,",
                    "    modal: true,",
                    "    icon: Ext.Msg.INFO",
                    "});",
                    "",
                    "QueryAddress.updateRecords(params,function(results){",
                    "    if(results.success===\"1\"){",
                    "        myMask.close();",
                    "        Ext.MessageBox.show({",
                    "            title: 'Начисление услуги',",
                    "            msg: results.msg,",
                    "            buttons: Ext.MessageBox.OK,",
                    "            icon: Ext.MessageBox.INFO",
                    "        });",
                    "    } else {",
                    "        myMask.close();",
                    "        Ext.MessageBox.show({",
                    "            title: 'Начисление услуги',",
                    "            msg: results.msg,",
                    "            buttons: Ext.MessageBox.OK,",
                    "            icon: Ext.MessageBox.ERROR",
                    "        });",
                    "    }",
                    "",
                    "});"
                ],
                "name": "click"
            },
            "name": "onBtAddNachTboClick",
            "designerId": "7f7585f8-1b69-455c-816a-eb9db7d8d7ba"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "#tabTbo",
                "designer|params": [
                    "component",
                    "eOpts"
                ],
                "designer|targetType": "Ext.panel.Panel",
                "fn": "onTabTboActivate",
                "implHandler": [
                    "//STORE",
                    "var form = Ext.getCmp('fmTbo');",
                    "var btAddNach = Ext.getCmp('btAddNachTbo');",
                    "var grid = Ext.getCmp('grTarifHousesTbo');",
                    "var store = grid.getStore();",
                    "store.removeAll();",
                    "var dt = new Date();",
                    "var firstDay = Ext.Date.getFirstDateOfMonth( dt ) ;",
                    "form.getForm().reset();",
                    "form.getForm().findField('data_nach').setValue(firstDay);",
                    "btAddNach.setText(\"Начислить ТБО за период   \"+ Ext.Date.format(firstDay, 'F,Y'));",
                    ""
                ],
                "name": "activate"
            },
            "name": "onTabTboActivate",
            "designerId": "21bb9e65-890b-4cac-a1ab-33d1c5e0709d"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "#grTarifHousesTbo",
                "designer|params": [
                    "model",
                    "selected",
                    "eOpts"
                ],
                "designer|targetType": "Ext.grid.Panel",
                "fn": "onGrTarifHousesTboSelectionChange",
                "implHandler": [
                    "//STORE",
                    "",
                    "var stAddress = Ext.data.StoreManager.get('StAddressOrg');",
                    "var form = Ext.getCmp('fmTbo');",
                    "var btAddPerer = Ext.getCmp('btAddPererTbo');",
                    "var viborTarif = Ext.getCmp('cbTarifTbo');",
                    "var btAddNach = Ext.getCmp('btAddNachTbo');",
                    "var btAddNachTboPrev = Ext.getCmp('btAddNachTboPrev');",
                    "var btnInsTarif = Ext.getCmp('btnInsTarifTbo');",
                    "var tarif = Ext.getCmp('tarTbo');",
                    "",
                    "var dt = new Date();",
                    "var lastDay = Ext.Date.getLastDateOfMonth( dt ) ;",
                    "var firstDay = Ext.Date.getFirstDateOfMonth( dt ) ;",
                    "",
                    "//console.log(selected,index);",
                    "if (selected.length > 0) {",
                    "    form.getForm().loadRecord(selected[0]);",
                    "",
                    "    if (Ext.Date.format(Ext.Date.getFirstDateOfMonth(selected[0].data.data), 'Y-m-d') ==",
                    "        Ext.Date.format(Ext.Date.getFirstDateOfMonth(form.getForm().findField('data_nach').getValue()), 'Y-m-d')) {",
                    "        btAddNach.setDisabled(false);",
                    "        btAddNachTboPrev.setDisabled(false);",
                    "        btAddPerer.setDisabled(true);",
                    "        btnInsTarif.setDisabled(false);",
                    "",
                    "        form.getForm().findField('sdata').setValue(\"0\");",
                    "        form.getForm().findField('fdata').setValue(\"0\");",
                    "        form.getForm().findField('tbo').setValue(\"\");",
                    "        form.getForm().findField('info').setValue(\"\");",
                    "        form.getForm().findField('ch_tbo').setValue(\"\");",
                    "        form.getForm().findField('address_ot').clearValue();",
                    "        form.getForm().findField('address_do').clearValue();",
                    "        form.getForm().findField('allkv').setValue(1);",
                    "        viborTarif.clearValue();",
                    "        viborTarif.setDisabled(false);",
                    "",
                    "",
                    "",
                    "    }else{",
                    "        btAddNach.setDisabled(true);",
                    "        btAddNachTboPrev.setDisabled(true);",
                    "        btAddPerer.setDisabled(false);",
                    "        form.getForm().findField('sdata').setValue(Ext.Date.format(Ext.Date.getFirstDateOfMonth(selected[0].data.data), 'Y-m-d'));",
                    "        form.getForm().findField('fdata').setValue(Ext.Date.format( Ext.Date.getLastDateOfMonth(selected[0].data.data), 'Y-m-d'));",
                    "        form.getForm().findField('address_ot').clearValue();",
                    "        form.getForm().findField('address_do').clearValue();",
                    "        form.getForm().findField('allkv').setValue(1);",
                    "        form.getForm().findField('tarif_manual').setValue(0);",
                    "        viborTarif.setDisabled(true);",
                    "        btnInsTarif.setDisabled(true);",
                    "    }",
                    "    tarif.setValue(0);",
                    "",
                    "",
                    "    stAddress.removeAll();",
                    "    stAddress.load({",
                    "        params: {",
                    "            what:'AddressFromHousesTarif',",
                    "            house_id: selected[0].data.house_id",
                    "        },",
                    "        callback: function(records,operation,success){",
                    "            if(success){",
                    "                form.getForm().findField('address_ot').setValue(records[0].get('address_id'));",
                    "                form.getForm().findField('address_do').setValue(records[0].get('address_id'));",
                    "            }",
                    "",
                    "        },",
                    "        scope:this",
                    "    });",
                    "",
                    "}",
                    ""
                ],
                "name": "selectionchange"
            },
            "name": "onGrTarifHousesTboSelectionChange",
            "designerId": "ec2d9a07-1cfa-4e81-9f8f-017e199a287f"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "#btAddNachTboPrev",
                "designer|params": [
                    "button",
                    "e",
                    "eOpts"
                ],
                "designer|targetType": "Ext.button.Button",
                "fn": "onBtAddNachTboPrevClick",
                "implHandler": [
                    "// in use",
                    "var me = this;",
                    "//STORE",
                    "var stUser = Ext.data.StoreManager.get(\"StUser\");",
                    "var grid =  Ext.getCmp('grTarifHousesTbo');",
                    "",
                    "var getRowSelection = grid.getSelectionModel().getSelection()[0];",
                    "var house_id = getRowSelection.get('house_id');",
                    "//LOGIN & PASSWORD",
                    "var values =stUser.getAt(0);",
                    "var params = {",
                    "    login:values.get('login'),",
                    "    password:values.get('password'),",
                    "    what:\"nachislenie_tbo_prev\",",
                    "    house_id:house_id",
                    "};",
                    "",
                    "",
                    "//LOGIKA",
                    "",
                    "var myMask= Ext.Msg.show({",
                    "    title:'Начисление...',",
                    "    msg: 'Начисление услуги.Ожидайте...',",
                    "    buttons: Ext.Msg.CANCEL,",
                    "    wait: true,",
                    "    modal: true,",
                    "    icon: Ext.Msg.INFO",
                    "});",
                    "",
                    "QueryAddress.updateRecords(params,function(results){",
                    "    if(results.success===\"1\"){",
                    "        myMask.close();",
                    "        Ext.MessageBox.show({",
                    "            title: 'Начисление услуги',",
                    "            msg: results.msg,",
                    "            buttons: Ext.MessageBox.OK,",
                    "            icon: Ext.MessageBox.INFO",
                    "        });",
                    "    } else {",
                    "        myMask.close();",
                    "        Ext.MessageBox.show({",
                    "            title: 'Начисление услуги',",
                    "            msg: results.msg,",
                    "            buttons: Ext.MessageBox.OK,",
                    "            icon: Ext.MessageBox.ERROR",
                    "        });",
                    "    }",
                    "",
                    "});"
                ],
                "name": "click"
            },
            "name": "onBtAddNachTboPrevClick",
            "designerId": "e68aec67-7f8a-4f2d-8884-e6a19f81511b"
        }
    ]
}