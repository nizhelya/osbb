/*
 * File: app/view/flat/TabAppBti.js
 *
 * This file was generated by Sencha Architect version 3.2.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.1.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.1.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Osbb.view.flat.TabAppBti', {
    extend: 'Ext.panel.Panel',
    alias: 'widget.tabappbti',

    requires: [
        'Ext.grid.Panel',
        'Ext.view.Table',
        'Ext.grid.column.Action',
        'Ext.grid.column.Number',
        'Ext.grid.column.Date',
        'Ext.panel.Tool',
        'Ext.form.Panel',
        'Ext.form.FieldSet',
        'Ext.form.field.Number',
        'Ext.button.Button',
        'Ext.form.field.Checkbox',
        'Ext.form.field.TextArea',
        'Ext.form.field.Date',
        'Ext.form.field.Display',
        'Ext.form.field.Hidden'
    ],

    id: 'tabAppBti',
    scrollable: true,
    width: 1020,
    title: 'БТИ',
    defaultListenerScope: true,

    items: [
        {
            xtype: 'panel',
            width: 1020,
            layout: 'anchor',
            header: false,
            title: 'My Panel',
            items: [
                {
                    xtype: 'gridpanel',
                    anchor: '100%',
                    id: 'grFamaly',
                    margin: '5 5 5 5',
                    scrollable: true,
                    width: 1010,
                    animCollapse: true,
                    collapsed: true,
                    collapsible: true,
                    title: 'Состав квартиросьемщиков по квартире',
                    bufferedRenderer: false,
                    columnLines: true,
                    emptyText: 'записей нет',
                    store: 'StFamaly',
                    viewConfig: {
                        emptyText: ' Записей нет'
                    },
                    columns: [
                        {
                            xtype: 'actioncolumn',
                            width: 40,
                            menuDisabled: true,
                            items: [
                                {
                                    handler: function(view, rowIndex, colIndex, item, e, record, row) {
                                        var dt = new Date();
                                        var winfamaly = Ext.ClassManager.instantiateByAlias('widget.winfamaly');
                                        var form = winfamaly.down('#fmFamaly');
                                        var stUser = Ext.data.StoreManager.get("StUser");
                                        //var StFamaly = Ext.data.StoreManager.get("stFamaly");

                                        var values =stUser.getAt(0);
                                        //StFamaly.proxy.setExtraParam('login', values.get('login'));
                                        //StFamaly.proxy.setExtraParam('password',values.get('password'));
                                        //StFamaly.load();

                                        var value = record;
                                        //console.log(value);
                                        view.getSelectionModel().select(rowIndex);
                                        values.set({'vibor':'editCitizen'});
                                        stUser.sync();
                                        form.loadRecord(value);
                                        form.down('#winBtnAddCitizen').setText('Обновить данные по квартиросьемщику');
                                        winfamaly.setTitle('Редактирование данных по квартиросьемщику');
                                        winfamaly.show();
                                    },
                                    icon: 'resources/css/images/ico/edit.png'
                                }
                            ]
                        },
                        {
                            xtype: 'numbercolumn',
                            hidden: true,
                            dataIndex: 'address_id',
                            text: 'Address_id'
                        },
                        {
                            xtype: 'gridcolumn',
                            renderer: function(value, metaData, record, rowIndex, colIndex, store, view) {
                                return Ext.String.format('<div  <b>{0}</b>&nbsp;&nbsp;<span class="author">{1} </span><br><span class="author">{2}</span></div>',
                                value,
                                record.get('firstname') || "",
                                record.get('lastname') || "");
                            },
                            width: 214,
                            dataIndex: 'surname',
                            menuDisabled: true,
                            text: 'Фамилия Имя Отчество'
                        },
                        {
                            xtype: 'gridcolumn',
                            width: 141,
                            dataIndex: 'rodstvo',
                            menuDisabled: true,
                            text: 'родство'
                        },
                        {
                            xtype: 'datecolumn',
                            width: 90,
                            align: 'center',
                            dataIndex: 'datap',
                            menuDisabled: true,
                            text: 'Дата рег',
                            format: 'd-m-Y'
                        },
                        {
                            xtype: 'gridcolumn',
                            width: 107,
                            dataIndex: 'inn',
                            menuDisabled: true,
                            text: 'инн'
                        },
                        {
                            xtype: 'datecolumn',
                            width: 90,
                            align: 'center',
                            dataIndex: 'born',
                            menuDisabled: true,
                            text: 'Дата рожд',
                            format: 'd-m-Y'
                        },
                        {
                            xtype: 'gridcolumn',
                            renderer: function(value, metaData, record, rowIndex, colIndex, store, view) {
                                return Ext.String.format('<div <b>{0} </b><br><span class="author">серия &nbsp; {1} номер &nbsp;&nbsp;&nbsp;</span><span class="author">{2}</span></div>',
                                value,
                                record.get('seria') || "",
                                record.get('nomer') || "");
                            },
                            width: 171,
                            dataIndex: 'document',
                            menuDisabled: true,
                            text: 'Документ'
                        },
                        {
                            xtype: 'gridcolumn',
                            renderer: function(value, metaData, record, rowIndex, colIndex, store, view) {
                                switch (value) {
                                    case "да":
                                    metaData='<span><img clas="icon" src="resources/css/images/ico/yes.png"/></span>';
                                    break;
                                    case "нет":
                                    metaData='<span><img clas="icon" src="resources/css/images/ico/no.png"/></span>';
                                    break;
                                }
                                return metaData;

                            },
                            width: 59,
                            align: 'center',
                            dataIndex: 'subsidia',
                            menuDisabled: true,
                            text: 'субс'
                        },
                        {
                            xtype: 'gridcolumn',
                            renderer: function(value, metaData, record, rowIndex, colIndex, store, view) {
                                switch (value) {
                                    case "да":
                                    metaData='<span><img clas="icon" src="resources/css/images/ico/yes.png"/></span>';
                                    break;
                                    case "нет":
                                    metaData='<span><img clas="icon" src="resources/css/images/ico/no.png"/></span>';
                                    break;
                                }
                                return metaData;

                            },
                            width: 53,
                            align: 'center',
                            dataIndex: 'vkl',
                            menuDisabled: true,
                            text: 'Вкл'
                        },
                        {
                            xtype: 'actioncolumn',
                            width: 40,
                            menuDisabled: true,
                            icon: '',
                            items: [
                                {
                                    handler: function(view, rowIndex, colIndex, item, e, record, row) {
                                        Ext.Msg.prompt('Name', 'Справка дана для предоставления в ............:', function(btn, text){

                                            if (btn == 'ok'){
                                                if (text !=="") {

                                                    var StUser = Ext.data.StoreManager.get("StUser");
                                                    var StReport = Ext.data.StoreManager.get("StReport");
                                                    var values =StUser.getAt(0);
                                                    var addr = values.data.address_id;
                                                    var rec_id = record.data.rec_id;


                                                    var usertype = 1;

                                                    //V
                                                    var tabPnCenter =  Ext.getCmp('tabPnCenter');//me.getTabPnCenter();


                                                    //C

                                                    if (addr) {

                                                        var report = 'Spravka';
                                                        var namereport = 'Справка';

                                                        var value = {
                                                            login:values.get('login'),
                                                            password:values.get('password'),
                                                            report:report,
                                                            what:report,
                                                            kuda:text,
                                                            address_id: addr,
                                                            rec_id: rec_id

                                                        };

                                                        var tab = tabPnCenter.child('#'+report);

                                                        if (!tab) {
                                                            tab  = tabPnCenter.add({
                                                                xtype:'tabreportorg',
                                                                title:namereport,

                                                                id:''+report+''
                                                            });

                                                            tabPnCenter.setActiveTab(tab);

                                                        }else{

                                                            tabPnCenter.setActiveTab(tab);
                                                        }

                                                        var reppan = tab.getComponent(0);


                                                        var myMask =new Ext.LoadMask({
                                                            target: reppan ,
                                                            msg:"Загрузка..."
                                                        });
                                                        myMask.show();

                                                        QueryReport.getResults(value,function(data){
                                                            if (data){

                                                                //    reportHead.update(data.head);
                                                                reppan.update(data.content);
                                                                //      reportFoot.update(data.foot);
                                                                Ext.REPORTCONTENT =data.content;
                                                                myMask.hide();


                                                            } else {
                                                                myMask.hide();
                                                                Ext.MessageBox.show({
                                                                    title: 'Ошибка ',
                                                                    msg: 'Документ не создан',
                                                                    buttons: Ext.MessageBox.OK,
                                                                    icon: Ext.MessageBox.ERROR

                                                                });

                                                            }

                                                        });


                                                    }

                                                }

                                                else
                                                {
                                                    Ext.MessageBox.show({
                                                        title: 'Ошибка ',
                                                        msg: 'Не введена организация куда предоставляется справка',
                                                        buttons: Ext.MessageBox.OK,
                                                        icon: Ext.MessageBox.ERROR
                                                    });
                                                }
                                            }

                                        });

                                    },
                                    icon: 'resources/css/images/ico/printer.png',
                                    tooltip: 'печать справки'
                                }
                            ]
                        }
                    ],
                    tools: [
                        {
                            xtype: 'tool',
                            callback: function(owner, tool, event) {
                                //in use
                                var winfamaly = Ext.ClassManager.instantiateByAlias('widget.winfamaly');

                                var dt = new Date();

                                var form = winfamaly.down('#fmFamaly');
                                var stUser = Ext.data.StoreManager.get("StUser");
                                var StFamaly = Ext.data.StoreManager.get("StFamaly");
                                var fmAppartment =  Ext.getCmp('fmAppartment');
                                var nanim = fmAppartment.getForm().findField('nanim').getValue();
                                var address_id = fmAppartment.getForm().findField('address_id').getValue();

                                var values =stUser.getAt(0);


                                //LOGIKA'
                                values.set({'vibor':'addCitizen'});
                                stUser.sync();


                                form.down('#winBtnAddCitizen').setText('Добавить квартиросьемщика');
                                form.getForm().findField('surname').setValue(nanim);
                                form.getForm().findField('address_id').setValue(address_id);

                                winfamaly.setTitle('Добовление квартиросьемщика');
                                winfamaly.show();
                                //spot.show(winLgotnik);
                            },
                            tooltip: 'Добавить квартиросьемшика',
                            type: 'plus'
                        },
                        {
                            xtype: 'tool',
                            callback: function(owner, tool, event) {
                                //in use
                                var grid = tool.findParentByType('grid');
                                //STORE
                                var stUser = Ext.data.StoreManager.get("StUser");
                                var StFamaly = Ext.data.StoreManager.get("StFamaly");
                                //LOGIN & PASSWORD
                                var values =stUser.getAt(0);

                                //LOGIKA


                                StFamaly.removeAll();
                                StFamaly.load({
                                    params: {
                                        login:values.get('login'),
                                        password:values.get('password'),
                                        address_id:values.get('address_id'),
                                        what_id:values.get('address_id'),
                                        what:"HistoryFamaly"
                                    },
                                    callback: function(records,operation,success){
                                        if(success){
                                            //  console.log(grid);
                                            grid.getView().refresh();
                                        }
                                    },
                                    scope:this
                                });
                            },
                            tabIndex: 3,
                            tooltip: 'Показать историю Добавить квартиросьемшиков',
                            type: 'search'
                        }
                    ]
                },
                {
                    xtype: 'form',
                    anchor: '100%',
                    id: 'fmAppartment',
                    scrollable: true,
                    bodyPadding: 10,
                    title: '',
                    items: [
                        {
                            xtype: 'fieldset',
                            height: 776,
                            width: 991,
                            layout: 'absolute',
                            title: 'Общая информация по квартире',
                            items: [
                                {
                                    xtype: 'fieldset',
                                    x: 0,
                                    y: 0,
                                    height: 170,
                                    style: 'background-color: #DCDCDC;',
                                    width: 445,
                                    layout: 'absolute',
                                    title: '',
                                    items: [
                                        {
                                            xtype: 'numberfield',
                                            x: 0,
                                            y: 10,
                                            width: 90,
                                            fieldLabel: 'Код',
                                            labelPad: 15,
                                            labelSeparator: ' ',
                                            labelWidth: 20,
                                            name: 'address_id',
                                            readOnly: true,
                                            editable: false,
                                            hideTrigger: true,
                                            allowDecimals: false,
                                            decimalPrecision: 0
                                        },
                                        {
                                            xtype: 'numberfield',
                                            x: 230,
                                            y: 135,
                                            height: 25,
                                            width: 165,
                                            fieldLabel: 'с.код',
                                            labelPad: 15,
                                            labelSeparator: ' ',
                                            labelWidth: 30,
                                            name: 'kod',
                                            hideTrigger: true,
                                            maxLength: 15,
                                            allowDecimals: false,
                                            decimalPrecision: 0
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 0,
                                            y: 40,
                                            width: 420,
                                            fieldLabel: 'Гл. наниматель',
                                            labelSeparator: ' ',
                                            labelWidth: 120,
                                            name: 'nanim'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 0,
                                            y: 70,
                                            width: 420,
                                            fieldLabel: 'Собственник',
                                            labelSeparator: ' ',
                                            labelWidth: 80,
                                            name: 'fio'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 0,
                                            y: 100,
                                            width: 420,
                                            fieldLabel: 'Телефоны',
                                            labelSeparator: ' ',
                                            labelWidth: 65,
                                            name: 'phone'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 0,
                                            y: 135,
                                            width: 195,
                                            fieldLabel: 'Email',
                                            labelSeparator: ' ',
                                            labelWidth: 40,
                                            name: 'email',
                                            emptyText: 'user@example.com',
                                            vtype: 'email'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 100,
                                            y: 10,
                                            width: 320,
                                            fieldLabel: 'Адрес',
                                            labelSeparator: ' ',
                                            labelWidth: 50,
                                            name: 'address'
                                        },
                                        {
                                            xtype: 'button',
                                            handler: function(button, event) {
                                                var stUser = Ext.data.StoreManager.get("StUser");
                                                var pvalues =stUser.getAt(0);
                                                var login = pvalues.get('login');
                                                var password = pvalues.get('password');

                                                var form = Ext.getCmp('fmAppartment');//Форма
                                                var stAppartment = Ext.data.StoreManager.get("StAppartment");

                                                var values=form.getValues();
                                                var address_id = values.address_id;
                                                var params = {
                                                    login:login,
                                                    password:password,
                                                    what:'EmailInfoAddress',
                                                    address_id:address_id
                                                };
                                                // console.log(values.address_id);
                                                Ext.Object.merge(values, params);

                                                var myMask= Ext.Msg.show({
                                                    title: 'Отправка информационного листка',
                                                    msg: 'Отправка информационного листка .Ожидайте...',
                                                    buttons: Ext.Msg.CANCEL,
                                                    wait: true,
                                                    modal: true,
                                                    icon: Ext.Msg.INFO
                                                });
                                                QueryAddress.updateRecords(params,function(results){
                                                    if(results.success==="1"){
                                                        setTimeout(function(){
                                                            QueryExportInfoApp.exportToEmail(params,function(results){
                                                                if(results.success){
                                                                    myMask.close();
                                                                    Ext.MessageBox.show({
                                                                        title: 'Отправка информационного листка',
                                                                        msg: results.msg,
                                                                        buttons: Ext.MessageBox.OK,
                                                                        icon: Ext.MessageBox.INFO
                                                                    });

                                                                } else {
                                                                    myMask.close();

                                                                    Ext.MessageBox.show({
                                                                        title: 'Отправка информационного листка',
                                                                        msg: results.msg,
                                                                        buttons: Ext.MessageBox.OK,
                                                                        icon: Ext.MessageBox.ERROR
                                                                    });
                                                                }
                                                            }, 250);
                                                        });
                                                    }

                                                });
                                            },
                                            x: 195,
                                            y: 130,
                                            formBind: true,
                                            icon: 'resources/css/images/news/icons8-email-24.png',
                                            scale: 'medium',
                                            tooltip: 'Отправка информационного листка',
                                            tooltipType: 'title'
                                        },
                                        {
                                            xtype: 'button',
                                            handler: function(button, event) {
                                                var stUser = Ext.data.StoreManager.get("StUser");
                                                var pvalues =stUser.getAt(0);
                                                var login = pvalues.get('login');
                                                var password = pvalues.get('password');
                                                var form = Ext.getCmp('fmAppartment');
                                                var stAppartment = Ext.data.StoreManager.get("StAppartment");
                                                var values=form.getValues();
                                                var address_id = values.address_id;
                                                var params = {
                                                    login:login,
                                                    password:password,
                                                    what:'AppartmentUpdateKod',
                                                    what_id:address_id
                                                };
                                                Ext.Object.merge(values, params);
                                                QueryAddress.updateRecords(values,function(result){
                                                    if (result.success){
                                                        Ext.MessageBox.show({
                                                            title: 'Обновление данных по квартире!',
                                                            msg: result.msg,
                                                            buttons: Ext.MessageBox.OK,
                                                            icon: Ext.MessageBox.INFO,
                                                            buttonText:{
                                                                ok: "Закрыть!"
                                                            }
                                                        });
                                                        stAppartment.load({
                                                            params: {
                                                                what_id:address_id,
                                                                address_id: address_id,
                                                                what:'Appartment',
                                                                login:login,
                                                                password:password
                                                            },
                                                            callback: function(records,operation,success){
                                                                var rec = records[0];
                                                                if(success){
                                                                    form.getForm().loadRecord(rec);
                                                                }
                                                            },
                                                            scope:this
                                                        });
                                                    }else{
                                                        Ext.MessageBox.show({
                                                            title: 'Внесение изменений',
                                                            msg: 'Произошла ошибка',
                                                            buttons: Ext.MessageBox.OK,
                                                            buttonText:{
                                                                ok: "Закрыть!"
                                                            },
                                                            icon: Ext.MessageBox.WARNING
                                                        });
                                                    }
                                                });
                                            },
                                            x: 395,
                                            y: 135,
                                            formBind: true,
                                            icon: 'resources/css/images/ico/xsldbg_refresh.png',
                                            tooltip: 'Оновить таємний код',
                                            tooltipType: 'title'
                                        }
                                    ]
                                },
                                {
                                    xtype: 'fieldset',
                                    x: 0,
                                    y: 300,
                                    height: 115,
                                    style: 'background-color: #DCDCDC;',
                                    width: 445,
                                    layout: 'absolute',
                                    title: 'Данные БТИ',
                                    items: [
                                        {
                                            xtype: 'checkboxfield',
                                            x: 0,
                                            y: 0,
                                            fieldLabel: 'Приват',
                                            labelWidth: 50,
                                            name: 'privat',
                                            boxLabel: 'Нет',
                                            inputValue: 'да',
                                            uncheckedValue: 'нет',
                                            listeners: {
                                                change: 'onCheckboxfieldChange1'
                                            }
                                        },
                                        {
                                            xtype: 'textareafield',
                                            x: 110,
                                            y: 0,
                                            width: 310,
                                            fieldLabel: 'Ордер',
                                            labelAlign: 'top',
                                            labelSeparator: ' ',
                                            labelWidth: 120,
                                            name: 'order',
                                            grow: true
                                        },
                                        {
                                            xtype: 'datefield',
                                            x: 0,
                                            y: 25,
                                            width: 100,
                                            fieldLabel: 'Дата ордера',
                                            labelAlign: 'top',
                                            name: 'data_ordera',
                                            format: 'd-m-Y',
                                            submitFormat: 'Y-m-d'
                                        }
                                    ]
                                },
                                {
                                    xtype: 'fieldset',
                                    x: 0,
                                    y: 175,
                                    height: 125,
                                    style: 'background-color: #DCDCDC;',
                                    width: 445,
                                    layout: 'absolute',
                                    title: 'Паспортные данные',
                                    items: [
                                        {
                                            xtype: 'textfield',
                                            x: 0,
                                            y: 0,
                                            cls: 'bti',
                                            width: 140,
                                            fieldLabel: 'Серия №',
                                            labelSeparator: ' ',
                                            labelWidth: 60,
                                            name: 'passport'
                                        },
                                        {
                                            xtype: 'datefield',
                                            x: 145,
                                            y: 0,
                                            width: 150,
                                            fieldLabel: 'Дата',
                                            labelSeparator: ' ',
                                            labelWidth: 35,
                                            name: 'viddata',
                                            format: 'd-m-Y',
                                            submitFormat: 'Ymd'
                                        },
                                        {
                                            xtype: 'textareafield',
                                            x: 10,
                                            y: 35,
                                            cls: 'bti',
                                            width: 360,
                                            fieldLabel: 'Выдан',
                                            labelSeparator: ' ',
                                            labelWidth: 50,
                                            name: 'vidan',
                                            grow: true
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 300,
                                            y: 0,
                                            width: 120,
                                            fieldLabel: 'Инн',
                                            labelSeparator: ' ',
                                            labelWidth: 30,
                                            name: 'inn'
                                        },
                                        {
                                            xtype: 'button',
                                            handler: function(button, event) {
                                                var me = this;
                                                var StUser = Ext.data.StoreManager.get("StUser");
                                                var StReport = Ext.data.StoreManager.get("StReport");
                                                var values =StUser.getAt(0);
                                                var addr = values.data.address_id;

                                                var usertype = 1;

                                                //V
                                                var tabPnCenter =  Ext.getCmp('tabPnCenter');//me.getTabPnCenter();


                                                //C

                                                if (addr) {

                                                    var report = 'HistoryFlatPayment';
                                                    var namereport = 'История платежей кв.';

                                                    var value = {
                                                        login:values.get('login'),
                                                        password:values.get('password'),
                                                        report:report,
                                                        what:report,
                                                        address_id: addr
                                                    };

                                                    var tab = tabPnCenter.child('#'+report);

                                                    if (!tab) {
                                                        tab  = tabPnCenter.add({
                                                            xtype:'tabreportorg',
                                                            title:namereport,
                                                            id:''+report+''
                                                        });

                                                        tabPnCenter.setActiveTab(tab);

                                                    }else{

                                                        tabPnCenter.setActiveTab(tab);
                                                    }

                                                    var reppan = tab.getComponent(0);


                                                    var myMask =new Ext.LoadMask({
                                                        target: reppan ,
                                                        msg:"Загрузка..."
                                                    });
                                                    myMask.show();

                                                    QueryReport.getResults(value,function(data){
                                                        if (data){

                                                            //    reportHead.update(data.head);
                                                            reppan.update(data.content);
                                                            //      reportFoot.update(data.foot);
                                                            Ext.REPORTCONTENT =data.content;
                                                            myMask.hide();


                                                        } else {
                                                            myMask.hide();
                                                            Ext.MessageBox.show({
                                                                title: 'Ошибка ',
                                                                msg: 'Документ не создан',
                                                                buttons: Ext.MessageBox.OK,
                                                                icon: Ext.MessageBox.ERROR

                                                            });

                                                        }

                                                    });


                                                }


                                            },
                                            x: 380,
                                            y: 45,
                                            id: 'btnHistoryPayFlat',
                                            icon: 'resources/css/images/ico/print_printer.png',
                                            scale: 'large',
                                            text: '',
                                            tooltip: 'История платежей по квартире',
                                            tooltipType: 'title'
                                        }
                                    ]
                                },
                                {
                                    xtype: 'fieldset',
                                    x: 455,
                                    y: 0,
                                    height: 230,
                                    style: 'background-color: #DCDCDC;',
                                    width: 145,
                                    title: 'Состав (человек)',
                                    items: [
                                        {
                                            xtype: 'numberfield',
                                            anchor: '100%',
                                            fieldLabel: 'Прописано',
                                            labelSeparator: ' ',
                                            labelWidth: 70,
                                            name: 'tenant',
                                            allowDecimals: false,
                                            decimalPrecision: 0,
                                            minValue: 0
                                        },
                                        {
                                            xtype: 'numberfield',
                                            anchor: '100%',
                                            fieldLabel: 'Отсутсут',
                                            labelSeparator: ' ',
                                            labelWidth: 70,
                                            name: 'absent',
                                            allowDecimals: false,
                                            decimalPrecision: 0,
                                            minValue: 0
                                        },
                                        {
                                            xtype: 'numberfield',
                                            anchor: '100%',
                                            fieldLabel: 'Поднаним',
                                            labelSeparator: ' ',
                                            labelWidth: 70,
                                            name: 'podnan',
                                            allowDecimals: false,
                                            decimalPrecision: 0,
                                            minValue: 0
                                        },
                                        {
                                            xtype: 'numberfield',
                                            anchor: '100%',
                                            fieldLabel: 'Льготник',
                                            labelSeparator: ' ',
                                            labelWidth: 70,
                                            name: 'lgotchik',
                                            allowDecimals: false,
                                            decimalPrecision: 0,
                                            minValue: 0
                                        },
                                        {
                                            xtype: 'checkboxfield',
                                            anchor: '100%',
                                            fieldLabel: 'Субсидия',
                                            labelAlign: 'right',
                                            labelWidth: 70,
                                            name: 'subsidia',
                                            boxLabel: 'Нет',
                                            inputValue: 'да',
                                            uncheckedValue: 'нет',
                                            listeners: {
                                                change: 'onCheckboxfieldChange13'
                                            }
                                        },
                                        {
                                            xtype: 'checkboxfield',
                                            anchor: '100%',
                                            fieldLabel: 'Лифт',
                                            labelAlign: 'right',
                                            labelWidth: 70,
                                            name: 'lift',
                                            boxLabel: 'Да',
                                            inputValue: 'да',
                                            uncheckedValue: 'нет',
                                            listeners: {
                                                change: 'onCheckboxfieldChange3'
                                            }
                                        },
                                        {
                                            xtype: 'displayfield',
                                            renderer: function(value, displayField) {
                                                var form = displayField.findParentByType('form');
                                                var lg = form.getForm().findField('lgotchik').getValue();
                                                //console.log(lg);
                                                var retValue = '';
                                                if(lg===0){
                                                    retValue ='<span><img class="icon" src="resources/css/images/ico/no.png"/></span>';
                                                } else {
                                                    retValue ='<span><img class="icon" src="resources/css/images/ico/yes.png"/></span>';
                                                }
                                                return retValue;
                                            },
                                            anchor: '100%',
                                            fieldLabel: 'Льгота',
                                            labelSeparator: ' ',
                                            name: 'lgota'
                                        }
                                    ]
                                },
                                {
                                    xtype: 'fieldset',
                                    x: 605,
                                    y: 0,
                                    height: 230,
                                    style: 'background-color: #DCDCDC;',
                                    width: 170,
                                    title: 'Площадь квартиры (м2)',
                                    items: [
                                        {
                                            xtype: 'numberfield',
                                            anchor: '100%',
                                            fieldLabel: 'Комнат',
                                            labelSeparator: ' ',
                                            labelWidth: 65,
                                            name: 'room',
                                            hideTrigger: true,
                                            allowDecimals: false,
                                            autoStripChars: true,
                                            decimalPrecision: 0
                                        },
                                        {
                                            xtype: 'numberfield',
                                            anchor: '100%',
                                            width: 153,
                                            fieldLabel: 'Полезная',
                                            labelSeparator: ' ',
                                            labelWidth: 65,
                                            name: 'area_full',
                                            hideTrigger: true,
                                            autoStripChars: true
                                        },
                                        {
                                            xtype: 'numberfield',
                                            anchor: '100%',
                                            fieldLabel: 'Жилая',
                                            labelSeparator: ' ',
                                            labelWidth: 65,
                                            name: 'area_life',
                                            hideTrigger: true,
                                            autoStripChars: true
                                        },
                                        {
                                            xtype: 'numberfield',
                                            anchor: '100%',
                                            fieldLabel: 'Допол',
                                            labelSeparator: ' ',
                                            labelWidth: 65,
                                            name: 'area_dop',
                                            hideTrigger: true,
                                            autoStripChars: true
                                        },
                                        {
                                            xtype: 'numberfield',
                                            anchor: '100%',
                                            fieldLabel: 'Балкон',
                                            labelSeparator: ' ',
                                            labelWidth: 65,
                                            name: 'area_balk',
                                            hideTrigger: true,
                                            autoStripChars: true
                                        },
                                        {
                                            xtype: 'textfield',
                                            anchor: '100%',
                                            fieldLabel: 'S отопл',
                                            hideEmptyLabel: false,
                                            labelSeparator: ' ',
                                            labelWidth: 65,
                                            name: 'area_otopl',
                                            growMin: 35
                                        }
                                    ]
                                },
                                {
                                    xtype: 'fieldset',
                                    x: 780,
                                    y: 0,
                                    height: 230,
                                    style: 'background-color: #DCDCDC;',
                                    width: 185,
                                    title: 'Приборы учета',
                                    items: [
                                        {
                                            xtype: 'checkboxfield',
                                            anchor: '100%',
                                            fieldLabel: 'Счетчик Хвода',
                                            labelWidth: 110,
                                            name: 'vxvoda',
                                            boxLabel: 'Нет',
                                            inputValue: 'да',
                                            uncheckedValue: 'нет',
                                            listeners: {
                                                change: 'onCheckboxfieldChange4'
                                            }
                                        },
                                        {
                                            xtype: 'checkboxfield',
                                            anchor: '100%',
                                            fieldLabel: 'Счетчик Гвода',
                                            labelWidth: 110,
                                            name: 'vgvoda',
                                            boxLabel: 'Нет',
                                            inputValue: 'да',
                                            uncheckedValue: 'нет',
                                            listeners: {
                                                change: 'onCheckboxfieldChange5'
                                            }
                                        },
                                        {
                                            xtype: 'checkboxfield',
                                            anchor: '100%',
                                            fieldLabel: 'Энергосчетчик',
                                            labelWidth: 110,
                                            name: 'energomer',
                                            boxLabel: 'Нет',
                                            inputValue: '1',
                                            uncheckedValue: '0',
                                            listeners: {
                                                change: 'onCheckboxfieldChange6'
                                            }
                                        },
                                        {
                                            xtype: 'checkboxfield',
                                            anchor: '100%',
                                            fieldLabel: 'Тепломер',
                                            labelWidth: 110,
                                            name: 'teplomer',
                                            boxLabel: 'Нет',
                                            inputValue: 'да',
                                            uncheckedValue: 'нет',
                                            listeners: {
                                                change: 'onCheckboxfieldChange2'
                                            }
                                        },
                                        {
                                            xtype: 'numberfield',
                                            anchor: '100%',
                                            fieldLabel: 'Дтепломер_ид',
                                            name: 'dteplomer_id',
                                            hideTrigger: true,
                                            allowDecimals: false,
                                            decimalPrecision: 0
                                        },
                                        {
                                            xtype: 'numberfield',
                                            anchor: '100%',
                                            fieldLabel: 'Дводомер_ид',
                                            name: 'dvodomer_id',
                                            hideTrigger: true,
                                            allowDecimals: false,
                                            decimalPrecision: 0
                                        }
                                    ]
                                },
                                {
                                    xtype: 'fieldset',
                                    x: 455,
                                    y: 240,
                                    height: 220,
                                    style: 'background-color: #DCDCDC;',
                                    width: 510,
                                    layout: 'absolute',
                                    title: 'Договора с коммунальными предприятиями',
                                    items: [
                                        {
                                            xtype: 'hiddenfield',
                                            x: 5,
                                            y: 35,
                                            id: 'fldDogVik',
                                            width: 210,
                                            fieldLabel: 'Дог.№',
                                            labelSeparator: ' ',
                                            labelWidth: 60,
                                            name: 'dog_vik'
                                        },
                                        {
                                            xtype: 'hiddenfield',
                                            x: 255,
                                            y: 35,
                                            id: 'fldDogYtke',
                                            width: 230,
                                            fieldLabel: 'Дог.№',
                                            labelSeparator: ' ',
                                            labelWidth: 60,
                                            name: 'dog_ytke'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 120,
                                            y: 40,
                                            width: 110,
                                            fieldLabel: 'тариф',
                                            labelSeparator: ' ',
                                            labelWidth: 40,
                                            name: 'tarif_xv'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 365,
                                            y: 40,
                                            width: 115,
                                            fieldLabel: 'тариф',
                                            labelSeparator: ' ',
                                            labelWidth: 40,
                                            name: 'tarif_ot',
                                            growMin: 35
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 120,
                                            y: 5,
                                            width: 110,
                                            fieldLabel: 'тариф',
                                            labelSeparator: ' ',
                                            labelWidth: 40,
                                            name: 'tarif_kv'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 240,
                                            y: 5,
                                            width: 105,
                                            fieldLabel: 'лифт',
                                            labelSeparator: ' ',
                                            labelWidth: 40,
                                            name: 'lifts'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 355,
                                            y: 5,
                                            width: 125,
                                            fieldLabel: 'допол',
                                            labelSeparator: ' ',
                                            labelWidth: 50,
                                            name: 'dop'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 365,
                                            y: 75,
                                            width: 115,
                                            fieldLabel: 'тариф',
                                            labelSeparator: ' ',
                                            labelWidth: 40,
                                            name: 'tarif_en'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 365,
                                            y: 110,
                                            width: 115,
                                            fieldLabel: 'тариф',
                                            labelSeparator: ' ',
                                            labelWidth: 40,
                                            name: 'tarif_tbo'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 120,
                                            y: 75,
                                            width: 110,
                                            fieldLabel: 'тариф',
                                            labelSeparator: ' ',
                                            labelWidth: 40,
                                            name: 'tarif_st'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 120,
                                            y: 110,
                                            width: 110,
                                            fieldLabel: 'тариф',
                                            labelSeparator: ' ',
                                            labelWidth: 40,
                                            name: 'tarif_rf'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 120,
                                            y: 145,
                                            width: 110,
                                            fieldLabel: 'тариф',
                                            labelSeparator: ' ',
                                            labelWidth: 40,
                                            name: 'tarif_vax'
                                        },
                                        {
                                            xtype: 'checkboxfield',
                                            x: 5,
                                            y: 40,
                                            fieldLabel: 'Хвода',
                                            labelWidth: 55,
                                            name: 'voda',
                                            boxLabel: 'Нет',
                                            inputValue: 'да',
                                            uncheckedValue: 'нет',
                                            listeners: {
                                                change: 'onCheckboxfieldChange7'
                                            }
                                        },
                                        {
                                            xtype: 'checkboxfield',
                                            x: 240,
                                            y: 40,
                                            fieldLabel: 'Отопление',
                                            labelWidth: 70,
                                            name: 'otoplenie',
                                            boxLabel: 'Нет',
                                            inputValue: 'да',
                                            uncheckedValue: 'нет',
                                            listeners: {
                                                change: 'onCheckboxfieldChange8'
                                            }
                                        },
                                        {
                                            xtype: 'checkboxfield',
                                            x: 240,
                                            y: 145,
                                            fieldLabel: 'Паркінг',
                                            labelWidth: 70,
                                            name: 'parking',
                                            boxLabel: 'Нет',
                                            inputValue: '1',
                                            uncheckedValue: '0',
                                            listeners: {
                                                change: 'onCheckboxfieldChange9'
                                            }
                                        },
                                        {
                                            xtype: 'checkboxfield',
                                            x: 240,
                                            y: 75,
                                            fieldLabel: 'Электроэн',
                                            labelWidth: 70,
                                            name: 'energy',
                                            boxLabel: 'Нет',
                                            inputValue: 'да',
                                            uncheckedValue: 'нет',
                                            listeners: {
                                                change: 'onCheckboxfieldChange10'
                                            }
                                        },
                                        {
                                            xtype: 'checkboxfield',
                                            x: 240,
                                            y: 110,
                                            fieldLabel: 'ТБО',
                                            labelWidth: 70,
                                            name: 'tbo',
                                            boxLabel: 'Нет',
                                            inputValue: 'да',
                                            uncheckedValue: 'нет',
                                            listeners: {
                                                change: 'onCheckboxfieldChange101'
                                            }
                                        },
                                        {
                                            xtype: 'checkboxfield',
                                            x: 5,
                                            y: 75,
                                            fieldLabel: 'Гвода',
                                            labelWidth: 55,
                                            name: 'stoki',
                                            boxLabel: 'Нет',
                                            inputValue: 'да',
                                            uncheckedValue: 'нет',
                                            listeners: {
                                                change: 'onCheckboxfieldChange11'
                                            }
                                        },
                                        {
                                            xtype: 'checkboxfield',
                                            x: 5,
                                            y: 110,
                                            fieldLabel: 'Р.Фонд',
                                            labelWidth: 55,
                                            name: 'rfond',
                                            boxLabel: 'Нет',
                                            inputValue: 'да',
                                            uncheckedValue: 'нет',
                                            listeners: {
                                                change: 'onCheckboxfieldChange111'
                                            }
                                        },
                                        {
                                            xtype: 'checkboxfield',
                                            x: 5,
                                            y: 145,
                                            fieldLabel: 'Вахта',
                                            labelWidth: 55,
                                            name: 'vaxta',
                                            boxLabel: 'Нет',
                                            inputValue: 'да',
                                            uncheckedValue: 'нет',
                                            listeners: {
                                                change: 'onCheckboxfieldChange1111'
                                            }
                                        },
                                        {
                                            xtype: 'checkboxfield',
                                            x: 5,
                                            y: 5,
                                            fieldLabel: 'Квартпл',
                                            labelWidth: 55,
                                            name: 'kvartplata',
                                            boxLabel: 'Нет',
                                            inputValue: 'да',
                                            uncheckedValue: 'нет',
                                            listeners: {
                                                change: 'onCheckboxfieldChange12'
                                            }
                                        }
                                    ]
                                },
                                {
                                    xtype: 'gridpanel',
                                    x: 0,
                                    y: 550,
                                    height: 210,
                                    id: 'grAppHistory',
                                    scrollable: true,
                                    width: 445,
                                    title: 'история изменений по квартире',
                                    emptyText: 'Нет данных для просмотра',
                                    store: 'StHAppartment',
                                    viewConfig: {
                                        id: 'grAppHistoryView'
                                    },
                                    columns: [
                                        {
                                            xtype: 'numbercolumn',
                                            hidden: true,
                                            dataIndex: 'address_id',
                                            text: 'Address_id'
                                        },
                                        {
                                            xtype: 'gridcolumn',
                                            hidden: true,
                                            dataIndex: 'address',
                                            text: 'Address'
                                        },
                                        {
                                            xtype: 'datecolumn',
                                            width: 80,
                                            dataIndex: 'data_change',
                                            menuDisabled: true,
                                            text: 'Дата',
                                            format: 'd-m-y'
                                        },
                                        {
                                            xtype: 'gridcolumn',
                                            renderer: function(value, metaData, record, rowIndex, colIndex, store, view) {
                                                metaData.style = 'white-space:pre-wrap;';
                                                return value;

                                            },
                                            dataIndex: 'what_change',
                                            menuDisabled: true,
                                            text: 'Описание изменений',
                                            flex: 1
                                        },
                                        {
                                            xtype: 'gridcolumn',
                                            width: 83,
                                            dataIndex: 'operator',
                                            menuDisabled: true,
                                            text: 'Оператор'
                                        }
                                    ]
                                },
                                {
                                    xtype: 'textareafield',
                                    x: 0,
                                    y: 455,
                                    style: 'background-color: #DCDCDC;',
                                    width: 445,
                                    fieldLabel: 'Последние изменения по квартире',
                                    labelAlign: 'top',
                                    labelWidth: 120,
                                    name: 'info',
                                    grow: true
                                },
                                {
                                    xtype: 'textareafield',
                                    x: 15,
                                    y: 195,
                                    height: 92,
                                    hidden: true,
                                    width: 300,
                                    fieldLabel: 'Последние изменения по квартире',
                                    labelAlign: 'top',
                                    labelWidth: 120,
                                    name: 'what_change'
                                },
                                {
                                    xtype: 'datefield',
                                    x: 115,
                                    y: 425,
                                    style: 'background-color: #DCDCDC;',
                                    width: 210,
                                    fieldLabel: 'Дата изм',
                                    labelWidth: 80,
                                    name: 'data_change',
                                    format: 'd-m-Y',
                                    submitFormat: 'Y-m-d',
                                    listeners: {
                                        select: 'onDatefieldSelect'
                                    }
                                },
                                {
                                    xtype: 'datefield',
                                    x: 315,
                                    y: 330,
                                    hidden: true,
                                    width: 125,
                                    fieldLabel: 'Дата изменений',
                                    labelAlign: 'top',
                                    name: 'chdata',
                                    format: 'd-m-Y',
                                    submitFormat: 'Y-m-d'
                                },
                                {
                                    xtype: 'button',
                                    handler: function(button, event) {
                                        //LOGIN & PASSWORD
                                        var stUser = Ext.data.StoreManager.get("StUser");
                                        var pvalues =stUser.getAt(0);
                                        var login = pvalues.get('login');
                                        var password = pvalues.get('password');

                                        var form = Ext.getCmp('fmAppartment');//Форма
                                        var stAppartment = Ext.data.StoreManager.get("StAppartment");//QueryAddress.getResults <Appartment>
                                        var StHAppartment = Ext.data.StoreManager.get("StHAppartment");


                                        var values=form.getValues();
                                        var address_id = values.address_id;
                                        var params = {
                                            login:login,
                                            password:password,
                                            what:'AppartmentChange',
                                            address_id:address_id
                                        };
                                        // console.log(values.address_id);
                                        Ext.Object.merge(values, params);

                                        // СОХРАНИТЬ ИЗМЕНЕНИЯ

                                        QueryAddress.updateRecords(values,function(result){

                                            if (result.success){

                                                Ext.MessageBox.show({
                                                    title: 'Обновление данных по квартире!',
                                                    msg: result.msg,
                                                    buttons: Ext.MessageBox.OK,
                                                    icon: Ext.MessageBox.INFO,
                                                    buttonText:{
                                                        ok: "Закрыть!"
                                                    }
                                                });

                                                stAppartment.load({
                                                    params: {
                                                        what_id:address_id,
                                                        address_id: address_id,
                                                        what:'Appartment',
                                                        login:login,
                                                        password:password
                                                    },
                                                    callback: function(records,operation,success){
                                                        var rec = records[0];

                                                        if(success){
                                                            StHAppartment.load({
                                                                params: {
                                                                    what_id:address_id,
                                                                    address_id: address_id,
                                                                    what:'HistoryAppartment',
                                                                    login:login,
                                                                    password:password
                                                                },
                                                                scope:this
                                                            });
                                                            stAppartment.sync();
                                                            form.getForm().loadRecord(rec);
                                                            form.doLayout();
                                                            form.getForm().loadRecord(rec);
                                                            form.doLayout();
                                                        }
                                                    },
                                                    scope:this
                                                });



                                            }else{
                                                Ext.MessageBox.show({
                                                    title: 'Внесение изменений',
                                                    msg: 'Произошла ошибка',
                                                    buttons: Ext.MessageBox.OK,
                                                    buttonText:{
                                                        ok: "Закрыть!"
                                                    },
                                                    icon: Ext.MessageBox.WARNING
                                                });
                                            }
                                        });

                                    },
                                    x: 335,
                                    y: 425,
                                    formBind: true,
                                    height: 25,
                                    id: 'BtnUpdateAppartment',
                                    width: 105,
                                    icon: 'resources/css/images/ico/yes.png',
                                    text: 'Записать'
                                },
                                {
                                    xtype: 'gridpanel',
                                    x: 455,
                                    y: 470,
                                    id: 'grLgotchikBti',
                                    scrollable: true,
                                    width: 510,
                                    title: 'Льготники',
                                    emptyText: 'Льготников нет',
                                    store: 'StLgotnik',
                                    viewConfig: {
                                        style: 'background-color: #C2D9A9;',
                                        emptyText: 'Льготников нет'
                                    },
                                    columns: [
                                        {
                                            xtype: 'actioncolumn',
                                            width: 40,
                                            menuDisabled: true,
                                            items: [
                                                {
                                                    handler: function(view, rowIndex, colIndex, item, e, record, row) {
                                                        var dt = new Date();
                                                        var winLgotnik = Ext.ClassManager.instantiateByAlias('widget.winlgotnik');
                                                        var form = winLgotnik.down('#fmLgotnik');
                                                        var stUser = Ext.data.StoreManager.get("StUser");
                                                        var StLgota = Ext.data.StoreManager.get("StLgota");

                                                        var values =stUser.getAt(0);
                                                        StLgota.proxy.setExtraParam('login', values.get('login'));
                                                        StLgota.proxy.setExtraParam('password',values.get('password'));
                                                        StLgota.load();

                                                        var value = record;
                                                        //console.log(value);
                                                        view.getSelectionModel().select(rowIndex);
                                                        values.set({'vibor':'editLgotnik'});
                                                        stUser.sync();
                                                        form.loadRecord(value);
                                                        form.down('#winBtnAddLgotnik').setText('Обновить данные по льготнику');
                                                        winLgotnik.setTitle('Редактирование данных по льготнику');
                                                        winLgotnik.show();
                                                    },
                                                    icon: 'resources/css/images/ico/edit.png'
                                                }
                                            ]
                                        },
                                        {
                                            xtype: 'numbercolumn',
                                            hidden: true,
                                            dataIndex: 'lgotnik_id',
                                            text: 'lgotnik_id',
                                            format: '0'
                                        },
                                        {
                                            xtype: 'numbercolumn',
                                            hidden: true,
                                            dataIndex: 'address_id',
                                            text: 'Address_id'
                                        },
                                        {
                                            xtype: 'numbercolumn',
                                            hidden: true,
                                            dataIndex: 'inn',
                                            text: 'инн',
                                            format: '0'
                                        },
                                        {
                                            xtype: 'gridcolumn',
                                            renderer: function(value, metaData, record, rowIndex, colIndex, store, view) {
                                                return Ext.String.format('<div class="topic"> <b>{0}</b><br><span class="author">{1} </span><br><span class="author">{2}</span></div>',
                                                value,
                                                record.get('firstname') || "",
                                                record.get('lastname') || "");
                                            },
                                            width: 130,
                                            dataIndex: 'surname',
                                            menuDisabled: true,
                                            text: 'Ф.И.О.'
                                        },
                                        {
                                            xtype: 'gridcolumn',
                                            renderer: function(value, metaData, record, rowIndex, colIndex, store, view) {
                                                metaData.style = 'white-space:pre-wrap;';
                                                return value;

                                            },
                                            width: 164,
                                            dataIndex: 'lgota',
                                            menuDisabled: true,
                                            text: 'льгота'
                                        },
                                        {
                                            xtype: 'numbercolumn',
                                            hidden: true,
                                            dataIndex: 'lgota_id',
                                            text: 'Льгота_ид',
                                            format: '0'
                                        },
                                        {
                                            xtype: 'gridcolumn',
                                            renderer: function(value, metaData, record, rowIndex, colIndex, store, view) {
                                                var retValue = '';
                                                if(value==="нет"){
                                                    return Ext.String.format('<div ><span>вкл <img clas="icon" src="resources/css/images/ico/no.png"/></span><br><span class="author">чел .{0} </span><br><span class="author">{1}%</span></div>',
                                                    record.get('people') || "0",
                                                    record.get('percent') || "");
                                                } else {
                                                    return Ext.String.format('<div ><span>вкл <img clas="icon" src="resources/css/images/ico/yes.png"/></span><br><span class="author">чел .{0} </span><br><span class="author">{1}%</span></div>',
                                                    record.get('people') || "0",
                                                    record.get('percent') || "");
                                                }

                                            },
                                            width: 85,
                                            dataIndex: 'vkl',
                                            menuDisabled: true,
                                            text: 'хар-ка'
                                        },
                                        {
                                            xtype: 'gridcolumn',
                                            renderer: function(value, metaData, record, rowIndex, colIndex, store, view) {
                                                return Ext.String.format('<div > <span class="author">с {0}</span><br><span class="author">по {1}</span></div>',
                                                Ext.Date.format(value, 'd-m-Y') ,
                                                Ext.Date.format(record.get('finish'), 'd-m-Y') || "");
                                            },
                                            width: 80,
                                            dataIndex: 'start',
                                            menuDisabled: true,
                                            text: 'период'
                                        }
                                    ],
                                    tools: [
                                        {
                                            xtype: 'tool',
                                            callback: function(owner, tool, event) {
                                                //in use
                                                var winLgotnik = Ext.ClassManager.instantiateByAlias('widget.winlgotnik');

                                                var dt = new Date();

                                                var form = winLgotnik.down('#fmLgotnik');
                                                var stUser = Ext.data.StoreManager.get("StUser");
                                                var StLgota = Ext.data.StoreManager.get("StLgota");

                                                var values =stUser.getAt(0);


                                                //LOGIKA'
                                                values.set({'vibor':'addLgotnik'});
                                                stUser.sync();

                                                StLgota.proxy.setExtraParam('login', values.get('login'));
                                                StLgota.proxy.setExtraParam('password',values.get('password'));
                                                StLgota.load();

                                                form.down('#winBtnAddLgotnik').setText('Добавить льготника');
                                                form.getForm().findField('start').setValue(Ext.Date.format(dt, 'd-m-Y'));
                                                form.getForm().findField('surname_ua').setValue();

                                                form.getForm().findField('data').setValue(Ext.Date.format(dt, 'd-m-Y'));

                                                winLgotnik.setTitle('Добовление льготника');
                                                winLgotnik.show();
                                                //spot.show(winLgotnik);
                                            },
                                            tooltip: 'Добавить льготчика',
                                            tooltipType: 'title',
                                            type: 'plus'
                                        },
                                        {
                                            xtype: 'tool',
                                            callback: function(owner, tool, event) {
                                                //in use
                                                var grid = tool.findParentByType('grid');
                                                //STORE
                                                var stUser = Ext.data.StoreManager.get("StUser");
                                                var stLgotnik = Ext.data.StoreManager.get("StLgotnik");
                                                //LOGIN & PASSWORD
                                                var values =stUser.getAt(0);

                                                //LOGIKA


                                                stLgotnik.removeAll();
                                                stLgotnik.load({
                                                    params: {
                                                        login:values.get('login'),
                                                        password:values.get('password'),
                                                        address_id:values.get('address_id'),
                                                        what_id:values.get('address_id'),
                                                        what:"HistoryLgotnik"
                                                    },
                                                    callback: function(records,operation,success){
                                                        if(success){
                                                            //  console.log(grid);
                                                            grid.getView().refresh();
                                                        }
                                                    },
                                                    scope:this
                                                });
                                            },
                                            tooltip: 'Показать историю льготников',
                                            type: 'search'
                                        }
                                    ]
                                },
                                {
                                    xtype: 'button',
                                    handler: function(button, event) {
                                        //LOGIN & PASSWORD
                                        var stUser = Ext.data.StoreManager.get("StUser");
                                        var pvalues =stUser.getAt(0);
                                        var login = pvalues.get('login');
                                        var password = pvalues.get('password');

                                        var form = Ext.getCmp('fmAppartment');//Форма
                                        var stAppartment = Ext.data.StoreManager.get("StAppartment");//QueryAddress.getResults <Appartment>
                                        var StHAppartment = Ext.data.StoreManager.get("StHAppartment");


                                        var values=form.getValues();
                                        var address_id = values.address_id;
                                        var params = {
                                            login:login,
                                            password:password,
                                            what:'AppartmentUpdate',
                                            what_id:address_id
                                        };
                                        // console.log(values.address_id);
                                        Ext.Object.merge(values, params);

                                        // СОХРАНИТЬ ИЗМЕНЕНИЯ

                                        QueryAddress.updateRecords(values,function(result){

                                            if (result.success){

                                                Ext.MessageBox.show({
                                                    title: 'Обновление данных по квартире!',
                                                    msg: result.msg,
                                                    buttons: Ext.MessageBox.OK,
                                                    icon: Ext.MessageBox.INFO,
                                                    buttonText:{
                                                        ok: "Закрыть!"
                                                    }
                                                });

                                                stAppartment.load({
                                                    params: {
                                                        what_id:address_id,
                                                        address_id: address_id,
                                                        what:'Appartment',
                                                        login:login,
                                                        password:password
                                                    },
                                                    callback: function(records,operation,success){
                                                        var rec = records[0];

                                                        if(success){
                                                            StHAppartment.load({
                                                                params: {
                                                                    what_id:address_id,
                                                                    address_id: address_id,
                                                                    what:'HistoryAppartment',
                                                                    login:login,
                                                                    password:password
                                                                },
                                                                scope:this
                                                            });
                                                            stAppartment.sync();
                                                            form.getForm().loadRecord(rec);
                                                            form.doLayout();
                                                            form.getForm().loadRecord(rec);
                                                            form.doLayout();
                                                        }
                                                    },
                                                    scope:this
                                                });



                                            }else{
                                                Ext.MessageBox.show({
                                                    title: 'Внесение изменений',
                                                    msg: 'Произошла ошибка',
                                                    buttons: Ext.MessageBox.OK,
                                                    buttonText:{
                                                        ok: "Закрыть!"
                                                    },
                                                    icon: Ext.MessageBox.WARNING
                                                });
                                            }
                                        });

                                    },
                                    x: 5,
                                    y: 425,
                                    formBind: true,
                                    height: 25,
                                    width: 105,
                                    icon: 'resources/css/images/ico/xsldbg_refresh.png',
                                    text: 'Обновить'
                                }
                            ]
                        },
                        {
                            xtype: 'hiddenfield',
                            anchor: '100%',
                            fieldLabel: 'Label',
                            name: 'house_id'
                        },
                        {
                            xtype: 'hiddenfield',
                            anchor: '100%',
                            fieldLabel: 'Label',
                            name: 'operator'
                        }
                    ]
                }
            ]
        }
    ],

    onCheckboxfieldChange1: function(field, newValue, oldValue, eOpts) {
        if(newValue){
            field.setBoxLabel("Да");
        }else{
            field.setBoxLabel("Нет");
        }
    },

    onCheckboxfieldChange13: function(field, newValue, oldValue, eOpts) {
        if(newValue){
            field.setBoxLabel("Да");
        }else{
            field.setBoxLabel("Нет");
        }
    },

    onCheckboxfieldChange3: function(field, newValue, oldValue, eOpts) {
        if(newValue){
            field.setBoxLabel("Да");
        }else{
            field.setBoxLabel("Нет");
        }
    },

    onCheckboxfieldChange4: function(field, newValue, oldValue, eOpts) {
        if(newValue){
            field.setBoxLabel("Да");
        }else{
            field.setBoxLabel("Нет");
        }
    },

    onCheckboxfieldChange5: function(field, newValue, oldValue, eOpts) {
        if(newValue){
            field.setBoxLabel("Да");
        }else{
            field.setBoxLabel("Нет");
        }
    },

    onCheckboxfieldChange6: function(field, newValue, oldValue, eOpts) {
        if(newValue){
            field.setBoxLabel("Да");
        }else{
            field.setBoxLabel("Нет");
        }
    },

    onCheckboxfieldChange2: function(field, newValue, oldValue, eOpts) {
        if(newValue){
            field.setBoxLabel("Да");
        }else{
            field.setBoxLabel("Нет");
        }
    },

    onCheckboxfieldChange7: function(field, newValue, oldValue, eOpts) {
        if(newValue){
            field.setBoxLabel("Да");
        }else{
            field.setBoxLabel("Нет");
        }
    },

    onCheckboxfieldChange8: function(field, newValue, oldValue, eOpts) {
        if(newValue){
            field.setBoxLabel("Да");
        }else{
            field.setBoxLabel("Нет");
        }
    },

    onCheckboxfieldChange9: function(field, newValue, oldValue, eOpts) {
        if(newValue){
            field.setBoxLabel("Да");
        }else{
            field.setBoxLabel("Нет");
        }
    },

    onCheckboxfieldChange10: function(field, newValue, oldValue, eOpts) {
        if(newValue){
            field.setBoxLabel("Да");
        }else{
            field.setBoxLabel("Нет");
        }
    },

    onCheckboxfieldChange101: function(field, newValue, oldValue, eOpts) {
        if(newValue){
            field.setBoxLabel("Да");
        }else{
            field.setBoxLabel("Нет");
        }
    },

    onCheckboxfieldChange11: function(field, newValue, oldValue, eOpts) {
        if(newValue){
            field.setBoxLabel("Да");
        }else{
            field.setBoxLabel("Нет");
        }
    },

    onCheckboxfieldChange111: function(field, newValue, oldValue, eOpts) {
        if(newValue){
            field.setBoxLabel("Да");
        }else{
            field.setBoxLabel("Нет");
        }
    },

    onCheckboxfieldChange1111: function(field, newValue, oldValue, eOpts) {
        if(newValue){
            field.setBoxLabel("Да");
        }else{
            field.setBoxLabel("Нет");
        }
    },

    onCheckboxfieldChange12: function(field, newValue, oldValue, eOpts) {
        if(newValue){
            field.setBoxLabel("Да");
        }else{
            field.setBoxLabel("Нет");
        }
    },

    onDatefieldSelect: function(field, value, eOpts) {
        Ext.getCmp('BtnUpdateAppartment').setText('Записать');
    }

});